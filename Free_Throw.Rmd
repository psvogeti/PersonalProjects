---
title: "Predicting the Free Throw"
author: "Pranav Vogeti"
date: "2023-11-22"
output: 
  html_document:
    mathjax: "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
---

```{css, echo=FALSE}
body {
  background-color: papayawhip
}
```

```{r message = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(lubridate)
library(kableExtra)
```

# Introduction

As the new 2023-2024 NBA season kicks into gear, and as I am beginning to learn more about predictive modeling, I was interested in seeing if there was a way to model the NBA free throw within the context the shot is performed. That context includes but is not limited to, the timestamp at which the free throw was taken, the player that took the free throw, and whether it was off of a contested interior shot or a contested perimeter shot, or if it was part of the bonus reward.

### The Focus Question

How might the NBA free throw shot be modeled such that the model can provide better insight then the player's career average free throw?

### Motivation

When watching an NBA game, the viewer is exposed to many types of shots, each equipped with their own play to achieve that particular shot. One such shot is the famed dunk. Another is a layup. Additional shots include the mid-range, the three-point shot, and the focus of this report: the free-throw.

The free throw is perhaps one of the most interesting shots in the game. The most obvious indicator is that it is by convention, *free*. When a free throw shot is taken, any and all play stops. The play clock pauses, fans become muted or monsters depending on what team is taking the shot, and if taken at the right moments, can prove to be pivotal indicators on a team's chances of winning in close games.

What spurs this investigation? The fact is, it is a **KNOWN** shot. Everybody, regardless of what age you are, how many years you have played, how skilled or talented you are, takes the exact same shot at the exact same point on the line. It is the only shot in the game that is known by every player. However, basing the free throw off of its known attributes ignores the true complexity behind the shot. It is a rather simple shot to learn and prepare for. The difficulty lies in the context at which it is taken.

For instance, a free throw in the opening minutes of a game, while the final score may disagree, will have significantly less impact morale wise than a free throw taken in the closing moments, when that shot determines the outcome of the close game. The pressure difference is hardly ignorable.

Moreover, the player taking the shot must be considered as well. Consider the world-famous basketball player [Shaquille O' Neal](https://www.basketball-reference.com/players/o/onealsh01.html). He was a monster in paint. Over his career, he has averaged 23.7 points per game, 10.9 rebounds per game, all on 58.2% overall field goal percentage. But his free throw percentage was a meager 52.7%, nearly a coin flip, and in some of those seasons, he performed worse than a coin flip. ]. Because of this, teams began implementing the "Hack - A - Shaq" strategy in the closing minutes of the game because the statistics were in the opposing team's favor. At best, Shaq's free throw performance was random. So how might the player impact the shot as well?

# Background

## Data Description

All of the data we will use will be at the [References] portion of this report.

### About the Original Data

#### About the Play-By-Play Data

The author that has provided the data for us to use is Vladislav Shufinsky. He has compiled NBA play-by-play data from 1996-2022 and made it open-source on Kaggle to allow us to use it for excursions like this[^1].

[^1]: <https://www.kaggle.com/datasets/brains14482/nba-playbyplay-and-shotdetails-data-19962021/data>

The data set we will use will contain a whole season's log of play-by-play data from the 2021-2022 NBA season. While the entire dataset consists of four subdata sets, we will choose to use the data originally sourced from *data.nba.com* This means that we will use the file called "*datanba_2022.csv*"

#### About the Player Shot Statistics Data

The original source of this data comes from Sports Reference, namely Basketball Reference[^2]. The data was queried and appended through Excel's Power Query feature and made use of Basketball Reference's tables for each team in the 2021-2022 season. The *Advanced* regular season table was used to obtain player data on games played, minutes played, usage rate, and free throw rate. The *Per Game* regular season table was used to obtain player data on free throws, field goal percentage, and effective field goal percentage. The queries have the format [*https://www.basketball-reference.com/teams/{team_abbr}/2022.html#per_game*](https://www.basketball-reference.com/teams/%7Bteam_abbr%7D/2022.html#per_game){.uri} and [*https://www.basketball-reference.com/teams/{team_abbr}/2022.html#advanced*](https://www.basketball-reference.com/teams/%7Bteam_abbr%7D/2022.html#advanced){.uri} for each team with Basketball Reference's team abbreviation standard.

[^2]: <https://www.basketball-reference.com/teams/MIN/2022.html>

The data hyperlinked is a sample one for Minnesota, but any team can be easily navigated to from the hyperlinked URL.

### The Key Variables

-   The key variables from the *Play-By-Play* we will use for this excursion:
    -   `cl` the time stamp at which the significant play occurred
    -   `de` the short form description of what the play was
    -   `hs` the home team total points at the `cl` moment
    -   `vs` the visiting team total points at the `cl` moment
    -   `pts` the pts scored by the respective `hs` or `vs` at the `cl` moment
    -   `PERIOD` the quarter of the game so as to distinct `cl`
    -   `GAME_ID` the numerical identifier of the game being played
-   The key variables from the *Player Shot Statistics* data set we will use for this excursion:
    -   `player` the NBA player of focus
    -   `team` the team of the NBA `player`
    -   `gms_played` the total number of games the `player` has participated in for the 2021-2022 regular season
    -   `min_played` the total number of minutes the `player` has participated in for the 2021-2022 regular season
    -   `usage_pct` an estimate of the percentage of `team` plays used by a `player` while he was on the floor [^3]
    -   `fgm` the average number of made field goals per game by the basketball `player`
    -   `fga` the number of field goal attempts per game by the basketball `player`
    -   `fg_pct` the ratio between `fgm` and `fga`
    -   `eff_fg_pct` "effective field goal percentage; the formula is (FG + 0.5 \* 3P) / FGA. This statistic adjusts for the fact that a 3-point field goal is worth one more point than a 2-point field goal"[^4]
    -   `ftm` the average number of made field goals per game by the basketball `player`
    -   `fta` the number of field goal attempts per game by the basketball `player`
    -   `ft_pct` the ratio between `ftm` and `fta`
    -   `ft_rate`the ratio between `fta` and `fga` and can be viewed as the rate at which the `player` visits the free throw line based on shots taken [^5]

[^3]: <https://www.basketball-reference.com/about/glossary.html>

[^4]: <https://www.basketball-reference.com/about/glossary.html>

[^5]: <https://www.nbastuffer.com/analytics101/free-throw-rate/>

### Assumptions and Unusuality

One assumption that will underline this report is the fact the assumption that any and all free throws, for the same stage of the game $S_n$ is the same. Consider a shooting regular foul $L$ on a two-point shot that occurred at the very beginning of the first quarter ($S_n = 1.1$). Similarly, consider the exact same foul for the last minutes of the fourth quarter ($S_n = 4.4$). Foul shot $F$ has a success probability $p = P(F)$ Across both cases $S_n$ is different so $P(F)$ may be different. But if $L$ occurs under the same $S_n$, $P(F)$ is the same. The only thing differentiating the probability of $F$ is $S_n$.

Moreover, while in $L$, $F$ is independent and identical. This gives us the following:

Given foul $L$ has free throw $F$ occuring at some interval in the game $S_n$:

$$
s \in S_n \mid S_n = \{1.1, 1.2, 1.3, 1.4, 1.5, 2.1, ..., 2.5, 3.1, ..., 6.5\}
$$

$$
\forall F \in s
$$

We Assume That:

$$
F \sim \text{Bernoulli(p)}
$$

Similarly, we will do the same for game point differential $D$. $D$ is categorical with five labels:

1)  `HOME DOMINATION` $(H_D)$ if home team is up by at least +15 or more

2)  `HOME LEADING`$(H_L)$ if home team is up as at least +5 but less than +15

3)  `TIGHT GAME`$(T_G)$ if home team is as at least -5 but less than +5 within the visiting team

4)  `VISIT LEADING` $(V_L)$ if home team is down at least -15 but less than -5

5)  `VISIT DOMINATION`$(V_D)$ if home team is down at least -15 or less

We use the $S_n$ assumption above to make this assumption. The assumption is that for any and all free throws, for the categorically same $D$ occurring in $S_n$ , foul shot $F$ with probability $P(F)$ is the same.

Consider a shooting regular foul $L$ on a two-point shot that occurred at the very beginning of the first quarter ($n = 1.1$) with the ***home*** team up by 10 ($D = H_L$). Similarly, consider the exact same foul just moments later ($n=1.1$) but now the ***visiting*** team is up by 5 ($D = V_L$). Foul shot $F \in L$ has a success probability $p = P(F)$. Across both cases $D$ is different so $P(F)$ may be different. But if $L$ occurs under the same $D$, $P(F)$ is the same. The only thing differentiating $P(F)$ is $D$.

Moreover, while in $L$, $F$ is independent and identical. This gives us the following:

Given foul $L$ has free throw $F$ occurring at some interval in the game $S_n$ with a current game point differential $D$ :

$$
d \in D \mid D = \{H_D, H_L, T_G, V_L, V_D\}
$$

$$
\forall F \in d
$$

We Assume That:

$$
F \sim \text{Bernoulli(p)}
$$

### Methodology

As stated before the goal is to create some model $m$, specific to the the state of the game $S_n$ and the score of the game $D$, that can accurately model $P(F)$

As a base line reference, we let the base line model be the null model $n$ with only $\beta_0$ representing the $p$'s season average free throw such that: $$
n \sim \{Y = \beta_0 \mid \beta_0 \in [0, 1]\}$$

Where $Y$ value represents $P(F)$

Once we find $m$, we will then assign $m$ to its respective player $p$ to become $m_p$. We will do this for all $p$ so that we can accomplish a dynamic function $f$ that, when passed in $p$, $S_n$ and $D$, returns the appropriate $m_p$

How do we get $f$?

Recall that $m$ depends on three things: $p$ which we choose, and then all instances of $S_n$, and $D$. Once we choose $p$, we get $m_p$. $S_n$ and $D$ then become the categorical specifications that $m_p$ is built on. The numerical predictors of $m_p$ depends on $p$'s statline. However, it is also highly likely that $m_p$ may not be built if $p$ does not have any $F$ in a particular $s \in S_n$ or a particular $d \in D$. If this is the case, then we avoid building $m_p$ and we will use $n$ to replace $m_p$ as the deferring model, where $n$ is only $p$'s season average free throw percentage

Here is the visualization of this how $p$'s models may vary depending on $D$ (the rows) and $S_n$ (the columns). Note, $n$ may be at any index of the array, it is just demonstrated that $n$ exists when a instance of $S_n$ and $D$ is not readily available

```{=tex}
\begin{array}{c|ccccccc} 

& 1.1 & 1.2 & 1.3 & 1.4 & 1.5 & \cdots & 6.5 \\


H_D & m_{1.1\times H_D} & m_{1.2\times H_D} & m_{1.3\times H_D} & m_{1.4\times H_D} & m_{1.5\times H_D} & \cdots & m_{6.5\times H_D}\\ 

H_L & m_{1.1\times H_L} & \ddots & m_{1.3\times H_L} & \cdots & \cdots & \cdots & \vdots\\ 

T_G & m_{1.1\times T_G} & n & \ddots & m_{1.4\times T_G} & n & \cdots & \vdots\\ 

V_L & m_{1.1\times V_L} & \cdots & \cdots & \ddots & m_{1.5\times V_L} & \cdots & \vdots\\

V_D & m_{1.1\times V_D} & \cdots & n & \cdots & \cdots & \cdots & m_{6.5\times V_D}\\
\end{array}
```
### Report Intentions

The rest of this report will showcase the data we are working with and their cleaned sets. Then, our analyses gets divided into three parts: part one will focus on finding $m$ for some $p$ and part two will aim to build $f$. Part three aims to show how $f$ can be used in as many informational contexts as possible. We will discuss about $f$ and highlight its pros and cons in our [Discussion] section. Finally, in our [Conclusion] section, we will provide alternative approaches to our query and also provide possible extensions as well.

# Analysis

### Data Cleanup

Here we will clean up our mentioned data sets and add and remove certain variables as needed. Any significant changes are reported at the bottom of the clean up section.

```{r read-print-raw-data}

raw_pbp_2022_data <- read.csv("../data/datanba_2022.csv")

##print the first 15 rows of this raw data
head(raw_pbp_2022_data, n=15)


##the data that has each player's relevant shooting stats
raw_player_data <- read.csv("../data/power_query_ft_model.csv")
```

Here we clean up our raw play-by-play data and output the cleaned data that we will work with.

```{r clean-pbp-data, echo=TRUE}

##the last name of the player, since that is what is in the pbp data
player_regex = "\\]\\s\\w+"
##to capture all "free throws"
free_throw_literal_regex = "Free Throw"
##to capture the score as a numeric from the description
score_regex = "[0-9]+"
##to capture the team code
team_regex = "\\[[A-Z]{3}"



pbp_2022_data <- raw_pbp_2022_data %>% select(
  cl, de, hs, vs, pts, PERIOD, GAME_ID
)

##get the home and away scores
free_throws_2022 <- pbp_2022_data %>% 
  filter(str_detect(de, free_throw_literal_regex)) %>%
  group_by(GAME_ID) %>%
  ## responsible for getting the teams involved in this game
  mutate(
    team = str_extract(de, regex(team_regex, FALSE)),
    player_team = substring(team, 2, 5), 
  ) %>%
  ##responsible for getting the player shooting the free throw
  mutate(
    player_identifier = str_extract(de, regex(player_regex, TRUE)), 
    player_shooting = substring(player_identifier, 3, last = 1000000L)
  ) %>% 
##responsible for classifying certain stage of the game in period.int format
  mutate(
    interval = case_when(
      cl <= "01:00" ~ 0.5,
      cl <= "03:00" ~ 0.4, 
      cl <= "06:00" ~ 0.3, 
      cl <= "09:00" ~ 0.2,
      cl <= "12:00" ~ 0.1), 
    stage_of_game = PERIOD + interval 
  ) %>% 
  ##difference in scores, postive is home team is ahead
  mutate(
    pt_difference = hs - vs, 
    pt_difference_cat = case_when(
      pt_difference >= 15 ~ "HOME DOMINATION", #[15, inf)
      pt_difference <= -15 ~ "VISIT DOMINATION", #(-inf, -15]
      pt_difference < -5 ~ "VISIT LEADING", #(-15, -5]
      pt_difference < 5 ~ "TIGHT GAME", #[-5, 5)
      pt_difference < 15  ~ "HOME LEADING") #[5, -15)
  ) %>%
  ##QoL change
  rename(gm_quarter = PERIOD) %>%
  select(GAME_ID, stage_of_game, gm_quarter, de, hs, vs, player_shooting, player_team, pts, pt_difference, pt_difference_cat)
  
##print out the first 10 rows of this new data set
head(free_throws_2022, n = 10)
```

As seen above, few new variables were introduced in this cleaner set:

-   `gm_quarter` the current NBA defined quarter of this match identified by the `GAME_ID`; any value above 4 is considered to be the overtime quarter

-   `player_shooting` the player shooting the free throw

-   `player_team` the team of the player shooting the free throw

-   `pt_difference` the difference between `hs` and `vs`, positive indicates home team score advantage

-   `pt_difference_cat` characterizes `pt_difference` into five distinct categories

    1)  `HOME DOMINATION` if `pt_difference` as at least +15 or more
    2)  `HOME LEADING` if `pt_difference` as at least +5 but less than +15
    3)  `TIGHT GAME` if `pt_difference` as at least -5 but less than +5
    4)  `VISIT LEADING` if `pt_difference` as at least -15 but less than -5
    5)  `VISIT DOMINATION`if `pt_difference` as at least -15 or less

Here we clean up our raw shot statistic data and output the cleaned data that we will work with.

```{r clean-player-data, echo=TRUE}
clean_player_data <- raw_player_data %>%
  mutate(min_per_gm = min_played/gms_played) %>%
  # remove players without any shot activity, especially free throws
  filter(fta != 0) %>%
  filter(fga != 0) %>%
  rename(player_team = team) %>%
  select(player_team, player, gms_played, min_per_gm, usage_pct, fgm, fga, fg_pct, eff_fg_pct, ftm, fta, ft_pct, ft_rate)

#print the first 10 rows of this data set
head(clean_player_data, n = 10)
```

As seen above, one new variable was introduced in this cleaner set: 

- `min_per_gm` the `player` ratio between `gms_played` and `min_played`

#### Analysis: Finding $m$ on a chosen $p$

Here, we are going to find $m$ for one particular player $p = \text{LeBron James}$. Why him? LeBron has been in the conversation for the greatest player of all time in the NBA. He has been mentioned in countless in-game situations and hypotheticals, making him a robust choice to find all his $m$.

In order to build the table outlined in the [Methodology] section, we need to get $n$. Since $n$ is merely the null model with its intercept term representing the season average free throw percentage, this is a quick fetch.

```{r n-LeBron, echo=TRUE}
player_of_interest = "LeBron James"
split_names <- strsplit(player_of_interest, " ")
last_name = tail(split_names[[1]], 1)

null_model_lebron <- clean_player_data %>% 
  filter(player == player_of_interest) %>% pull(ft_pct) %>% mean()

null_model_lebron
```

Before we build $m$, we need to join LeBron's statline to his free throw data. This will allow us to build $m$ off of one dataset.

```{r readying-m-LeBron, echo = TRUE}
##get the team based on our player
team_of_interest = clean_player_data %>%
  filter(player == player_of_interest) %>% pull(player_team) %>% str_extract(regex("\\w+"))

##get the player's free throw chart
free_throws_lebron <- free_throws_2022 %>%
  filter(player_team == team_of_interest) %>%
  filter(player_shooting == last_name)

lebron_shooting_data <- clean_player_data %>% filter(player == player_of_interest)

model_data_lebron <- full_join(free_throws_lebron, lebron_shooting_data, by = "player_team")
```

Now comes the fun part, building $m_\text{LeBron}$! First, let us plot all his $F$ depending on $S_n$ and $D$

```{r F-Sn, echo=TRUE}
ggplot(data=free_throws_lebron, aes(x=stage_of_game, y=pts, color = pt_difference_cat)) + 
  geom_jitter(alpha=.5, height=0.05) +
  facet_wrap(vars(gm_quarter), scales = "free_x") + 
  theme_dark() +
  theme(plot.background = element_rect(fill = "papayawhip")) + 
  theme(legend.background = element_rect(fill = "papayawhip")) + 
  scale_colour_manual(
    values = c("papayawhip", "burlywood1", "darkgoldenrod1", 
               "cyan1", "cyan3")) +
  labs(color = "Point Differential") +
  xlab("Stage of the Game") +
  ylab("Free Throw Shot Result") +
  ggtitle("LeBron's Free Throw Shot Results By Quarter and Stage of Game", 
          subtitle = "2021-2022 NBA Regular Season")
```

There is a lot going on in this faceted collection of graphs. 

We notice that the first quarter facet shows a lot of $F$ under $T_G$. This is expected because we defined it to be $T_G = [-5, 5)$ which is highly likely to be the result in the first quarter. This similar observation can be seen in "quarter 5" (overtime) facet, where $T_G$ makes its blanket appearance again. This is also expected behavior because in overtime, the teams have already played four quarters of basketball to have a tie game, and so the competition will be back and forth in overtime. Analyzing the fourth quarter facet, we see a greater density of missed $F$ than in any other facet. This is what we had a hunch on early on in this report. However, across all facets, in seems that $T_G$ dominates in the missed $F$ collection. 

The main takeaway with regards to this report is this: it is worth our time to include an interaction term between our categorical predictors $S_n$ and the numerical predictor $d \in D$. Doing so, will help us model situations we saw in facets 1, 4, and 5. 



```{r F-Sn-HA}

ggplot(data=free_throws_lebron, aes(x=stage_of_game, y=pts, color = home_team)) + 
  geom_jitter(alpha=.5, height=0.05) +
  facet_wrap(vars(gm_quarter), scales = "free_x") + 
  theme_dark() +
  theme(plot.background = element_rect(fill = "papayawhip")) + 
  theme(legend.background = element_rect(fill = "papayawhip")) + 
  scale_colour_manual(
    values = c("papayawhip", "burlywood1", "darkgoldenrod1", 
               "cyan1", "cyan3")) +
  labs(color = "Point Differential") +
  xlab("Stage of the Game") +
  ylab("Free Throw Shot Result") +
  ggtitle("LeBron's Free Throw Shot Results By Quarter and Stage of Game", 
          subtitle = "2021-2022 NBA Regular Season")

```


#### Analysis: Finding $f$

#### Analysis: Using $f$

# Discussion

In this section, we will discuss the results of our tests and models and their implications in the context of our question and also their broader implications and limitations.

### Comparing the Graphs & Overall Conclusions

Given that we are aiming to deliver an accurate model, the confusion matrix schema will be utilized to give fundamental statistics of our model. However, if there is one ultimate goal, we wish that based on our confusion matrix,

$$\text{Accuracy(m)} \geq \text{Accuracy(n)}$$

#### Graph Comparisons Discussion

[Placeholder]

### Shortcomings and Limitations

[Placeholder]

#### Limitation 1: [Placeholder]

[Placeholder]

#### Limitation 2: [Placeholder]

[Placeholder]

### Alternate Approaches

#### Alternate Approach 1

[Placeholder]

#### Alternate Approach 2

[Placeholder]

### Potential Future Directions

#### Future Direction 1

[Placeholder]

#### Future Direction 2

[Placeholder]

# References
